<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SukiMart - Online Shopping</title>
  <style>
    /* --- Base / Reset --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root{
      --brand:#ee4d2d; --brand-2:#ff6b35; --danger:#ff4757; --text:#333; --muted:#666;
      --chip:#ffc107; --bg:#f5f5f5; --card:#fff; --shadow:0 2px 10px rgba(0,0,0,.1);
      --grad: linear-gradient(135deg,var(--brand),var(--brand-2));
    }
    body{ font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:var(--bg); color:var(--text); }

    /* --- Header --- */
    .header{ background:var(--grad); color:#fff; padding:1rem 0; position:sticky; top:0; z-index:100; box-shadow:0 2px 10px rgba(238,77,45,.3) }
    .header-container{ max-width:1200px; margin:0 auto; padding:0 1rem; display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap }
    .logo{ color:#fff; text-decoration:none; font-weight:800; font-size:1.8rem }
    .search-container{ flex:1; max-width:650px; position:relative }
    .search-box{ width:100%; padding:.8rem 1rem; border:none; border-radius:6px; font-size:1rem; outline:none }

    .header-actions{ display:flex; align-items:center; gap:.75rem }
    .add-item-btn{ background:rgba(255,255,255,.2); color:#fff; border:1px solid rgba(255,255,255,.3); padding:.6rem 1rem; border-radius:6px; cursor:pointer; font-weight:600 }
    .add-item-btn:hover{ background:rgba(255,255,255,.3) }

    /* Bigger, high-contrast cart button */
    .cart-icon{ position:relative; background:#fff; color:var(--brand); border:none; padding:.7rem 1rem; border-radius:999px; cursor:pointer; font-weight:800; display:flex; align-items:center; gap:.5rem; box-shadow:0 4px 16px rgba(0,0,0,.12) }
    .cart-icon .icon{ font-size:1.4rem; line-height:0 }
    .cart-icon .label{ font-size:1rem }
    .cart-count{ position:absolute; top:-6px; right:-6px; background:var(--danger); color:#fff; border-radius:50%; width:24px; height:24px; font-size:.8rem; display:flex; align-items:center; justify-content:center; font-weight:800; box-shadow:0 2px 6px rgba(0,0,0,.2) }

    /* --- Layout --- */
    .container{ max-width:1200px; margin:0 auto; padding:2rem 1rem; position:relative }

    /* --- Products grid --- */
    .products-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:1.5rem }
    .product-card{ background:var(--card); border-radius:10px; overflow:hidden; box-shadow:var(--shadow); transition:.25s transform,.25s box-shadow; position:relative }
    .product-card:hover{ transform:translateY(-4px); box-shadow:0 10px 28px rgba(0,0,0,.15) }
    .product-card.custom-item{ border:2px solid var(--brand) }
    .custom-badge{ position:absolute; top:10px; right:10px; background:var(--brand); color:#fff; padding:.2rem .5rem; border-radius:12px; font-size:.7rem; font-weight:800 }

    .product-image{ width:100%; height:200px; object-fit:cover }
    .product-info{ padding:1rem }
    .product-name{ font-size:1rem; font-weight:700; margin-bottom:.5rem; color:#222; line-height:1.4 }
    .product-price{ font-size:1.25rem; font-weight:800; color:var(--brand); margin-bottom:.5rem }
    .product-rating{ display:flex; align-items:center; gap:.5rem; margin-bottom:1rem }
    .stars{ color:var(--chip) }
    .rating-text{ color:var(--muted); font-size:.9rem }

    .card-actions{ display:flex; gap:.5rem; flex-wrap:wrap }
    .btn{ padding:.65rem .9rem; border:none; border-radius:8px; cursor:pointer; font-weight:700 }
    .btn-primary{ background:var(--brand); color:#fff }
    .btn-primary:hover{ background:#d63821 }
    .btn-ghost{ background:#f3f3f3 }
    .btn-ghost:hover{ background:#e9e9e9 }
    .btn-danger{ background:var(--danger); color:#fff }
    .btn-danger:hover{ filter:brightness(.95) }

    /* --- Sidebar cart --- */
    .cart-sidebar{ position:fixed; top:0; right:-420px; width:420px; height:100vh; background:#fff; box-shadow:-2px 0 20px rgba(0,0,0,.15); transition:right .3s; z-index:200; display:flex; flex-direction:column }
    .cart-sidebar.open{ right:0 }
    .cart-header{ padding:1.2rem 1rem; background:var(--brand); color:#fff; display:flex; align-items:center; justify-content:space-between }
    .cart-title{ font-size:1.2rem; font-weight:800 }
    .close-cart{ background:#fff; color:var(--brand); border:none; padding:.6rem 1rem; border-radius:999px; font-weight:800; cursor:pointer }

    .cart-items{ flex:1; padding:1rem; overflow-y:auto }
    .cart-item{ display:flex; align-items:center; gap:1rem; padding:1rem 0; border-bottom:1px solid #eee }
    .cart-item-image{ width:60px; height:60px; border-radius:6px; object-fit:cover }
    .cart-item-name{ font-weight:700; font-size:.95rem; color:#222 }
    .cart-item-price{ color:var(--brand); font-weight:800 }
    .quantity-controls{ display:flex; align-items:center; margin-top:.35rem }
    .quantity-btn{ background:#f0f0f0; border:1px solid #ddd; width:32px; height:32px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:1rem; border-radius:6px }
    .quantity-input{ width:48px; text-align:center; border:1px solid #ddd; border-left:none; border-right:none; height:32px; font-size:1rem }
    .remove-item{ background:var(--danger); color:#fff; border:none; padding:.5rem .7rem; border-radius:8px; cursor:pointer; font-size:.85rem }

    .cart-footer{ padding:1rem; border-top:1px solid #eee; background:#fafafa }
    .cart-total{ font-size:1.2rem; font-weight:800; color:#222; text-align:center; margin-bottom:1rem }
    .checkout-btn{ width:100%; padding:1rem; background:var(--brand); color:#fff; border:none; border-radius:8px; font-weight:800; font-size:1.05rem; cursor:pointer }

    /* --- Modal (generic) --- */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; z-index:150 }
    .overlay.active{ display:block }

    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:300; animation:fadeIn .25s ease-out; padding:1rem }
    .modal.active{ display:flex }
    .modal-content{ background:#fff; border-radius:14px; width:92%; max-width:560px; max-height:85vh; overflow:auto; box-shadow:0 20px 40px rgba(0,0,0,.18); animation:slideUp .25s ease-out }
    .modal-header{ text-align:center; margin-bottom:1rem }
    .modal-header h2{ color:var(--brand); font-size:1.5rem; margin-bottom:.25rem }
    .modal-header p{ color:var(--muted) }

    /* Redesigned success modal hero */
    .modal-hero{
      background: var(--grad);
      color:#fff;
      padding:1.25rem 1rem;
      border-radius:14px 14px 0 0;
      display:flex; align-items:center; gap:.75rem;
    }
    .modal-hero .hero-icon{ font-size:1.6rem }
    .modal-hero .hero-title{ font-weight:900; letter-spacing:.3px }
    .modal-content .content-body{ padding:1.25rem }

    .order-summary h3{ margin:1rem 0; font-size:1.1rem }
    .order-item{ display:flex; align-items:center; gap:1rem; padding:.6rem 0; border-bottom:1px solid #eee }
    .order-item:last-child{ border-bottom:none }
    .order-item-image{ width:56px; height:56px; border-radius:6px; object-fit:cover }
    .order-item-name{ font-weight:700; color:#222; font-size:.95rem }
    .order-item-price{ color:var(--brand); font-weight:800; font-size:.95rem }
    .order-total{ text-align:center; padding:1rem 0; border-top:2px solid #eee; font-size:1.25rem; font-weight:800; color:var(--brand) }

    .modal-actions{ display:flex; gap:.5rem; margin-top:1rem }

    /* --- Add/Edit product form --- */
    .add-item-form{ background:#fff; border-radius:10px; padding:1.2rem; margin-bottom:2rem; box-shadow:var(--shadow); display:none }
    .add-item-form.active{ display:block }
    .form-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem }
    .form-header h3{ color:var(--brand); font-size:1.25rem }
    .close-form-btn{ background:#f3f3f3; border:none; padding:.6rem 1rem; border-radius:999px; cursor:pointer; font-weight:800 }

    .form-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:1rem }
    .form-group{ display:flex; flex-direction:column; gap:.4rem }
    .form-group label{ font-weight:700; color:#222 }
    .form-group input[type="text"], .form-group input[type="number"]{ padding:.8rem; border:1px solid #ddd; border-radius:8px; font-size:1rem; outline:none }
    .form-group input:focus{ border-color:var(--brand); box-shadow:0 0 0 2px rgba(238,77,45,.1) }

    .image-picker{ display:flex; gap:1rem; align-items:center }
    .image-preview{ width:100px; height:76px; border-radius:8px; object-fit:cover; background:#eee; border:1px dashed #ccc }

    .submit-item-btn{ width:100%; padding:1rem; background:var(--brand); color:#fff; border:none; border-radius:10px; font-weight:800; font-size:1.05rem; cursor:pointer; margin-top:.5rem }

    /* --- Delete confirmation modal --- */
    .confirm-text{ text-align:center; color:#444; margin:.25rem 0 .75rem }
    .confirm-actions{ display:flex; gap:.5rem; justify-content:center }

    /* --- Empty cart --- */
    .empty-cart{ text-align:center; padding:2rem; color:#fff; background: linear-gradient(180deg, rgba(238,77,45,.9), rgba(255,107,53,.85)); border-radius:10px }
    .empty-cart small{ display:block; opacity:.9; margin-top:.25rem }

    /* --- Animations --- */
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }
    @keyframes slideUp{ from{opacity:0; transform:translateY(30px)} to{opacity:1; transform:none} }
    @keyframes bump {
      0% { transform: translateY(0) scale(1); }
      30% { transform: translateY(-2px) scale(1.03); }
      60% { transform: translateY(0) scale(0.98); }
      100% { transform: translateY(0) scale(1); }
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255,255,255,.7); }
      70% { box-shadow: 0 0 0 12px rgba(255,255,255,0); }
      100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); }
    }

    /* --- Mobile Buy Now Bar --- */
    .buy-now-wrap{
      position: fixed;
      left: 0; bottom: 0; width: 100%;
      z-index: 300;
      pointer-events: none; /* container only */
    }
    .buy-now-bar{
      pointer-events: auto;
      background: var(--grad);
      color:#fff;
      display:flex; align-items:center; justify-content:space-between;
      padding:.85rem 1rem;
      gap:.75rem;
      transform: translateY(110%);
      opacity: 0;
      transition: transform .32s ease, opacity .32s ease;
      box-shadow: 0 -10px 24px rgba(238,77,45,.25);
    }
    .buy-now-bar.show{
      transform: translateY(0);
      opacity: 1;
    }
    .buy-summary{ font-weight:900; letter-spacing:.2px }
    .buy-summary .count{ font-weight:900 }
    .buy-summary .total{ font-weight:900 }
    .buy-now-btn{
      background:#fff; color:var(--brand);
      border:none; border-radius:999px; padding:.65rem 1.2rem;
      font-weight:900; cursor:pointer; box-shadow:0 6px 14px rgba(0,0,0,.18);
      display:flex; align-items:center; gap:.5rem;
      transition: transform .15s ease;
    }
    .buy-now-btn.bump{ animation: bump .4s ease both; }
    .buy-now-btn.pulse{ animation: pulse 1.1s ease-out 1; }

    .buy-now-bar.highlight{ outline: 2px dashed rgba(255,255,255,.9); outline-offset:-6px; border-radius:8px }

    /* Only visible on mobile; hide cart sidebar there */
    @media (max-width: 768px){
      .cart-sidebar{ display:none !important; }
      .buy-now-wrap{ display:block; }
    }
    @media (min-width: 769px){
      .buy-now-wrap{ display:none; }
    }

    /* --- Responsive --- */
    @media (max-width: 768px){
      .header-container{ flex-direction:column; align-items:stretch }
      .products-grid{ grid-template-columns:repeat(auto-fill,minmax(240px,1fr)) }
      .container{ padding:1rem 1rem 5.5rem } /* bottom padding for the bar */
    }
    @media (max-width:480px){ .products-grid{ grid-template-columns:repeat(auto-fill,minmax(200px,1fr)) } }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-container">
      <a class="logo" href="#">üõçÔ∏è SukiMart</a>
      <div class="search-container">
        <input id="searchInput" class="search-box" type="text" placeholder="Search for products..." />
      </div>
      <div class="header-actions">
        <button id="addItemToggle" class="add-item-btn">+ Add Item</button>
        <button id="cartToggle" class="cart-icon" title="Open Cart">
          <span class="icon">üõí</span>
          <span class="label">Cart</span>
          <span id="cartCount" class="cart-count">0</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <div class="container">
    <!-- Add/Edit Item Form -->
    <div id="addItemForm" class="add-item-form">
      <div class="form-header">
        <h3 id="formTitle">Add New Product</h3>
        <button id="closeForm" class="close-form-btn">Close</button>
      </div>
      <form id="productForm">
        <input type="hidden" id="editingId" value="" />
        <div class="form-grid">
          <div class="form-group">
            <label for="productName">Product Name</label>
            <input id="productName" type="text" required />
          </div>
          <div class="form-group">
            <label for="productPrice">Price (‚Ç±)</label>
            <input id="productPrice" type="number" step="0.01" min="0" required />
          </div>
          <div class="form-group">
            <label for="productRating">Rating (1-5)</label>
            <input id="productRating" type="number" min="1" max="5" step="0.1" value="4.0" required />
          </div>
          <div class="form-group">
            <label>Product Image</label>
            <div class="image-picker">
              <input id="productImageFile" type="file" accept="image/*" />
              <img id="imagePreview" class="image-preview" alt="Preview" />
            </div>
          </div>
        </div>
        <button class="submit-item-btn" type="submit">Save Product</button>
      </form>
    </div>

    <!-- Grid -->
    <div id="productsGrid" class="products-grid"></div>
  </div>

  <!-- Cart Sidebar (desktop only) -->
  <aside id="cartSidebar" class="cart-sidebar">
    <div class="cart-header">
      <div class="cart-title">Shopping Cart</div>
      <button id="closeCart" class="close-cart">Close</button>
    </div>
    <div id="cartItems" class="cart-items"></div>
    <div class="cart-footer">
      <div id="cartTotal" class="cart-total">Total: ‚Ç±0.00</div>
      <button class="checkout-btn" onclick="checkout()">Checkout</button>
    </div>
  </aside>

  <!-- Checkout Modal -->
  <div id="checkoutModal" class="modal">
    <div class="modal-content">
      <div class="modal-hero">
        <div class="hero-icon">üéâ</div>
        <div>
          <div class="hero-title">Order Successful!</div>
          <div style="opacity:.9">Thank you for your purchase</div>
        </div>
      </div>
      <div class="content-body">
        <div class="order-summary">
          <h3>Order Summary</h3>
          <div id="orderItems"></div>
          <div id="orderTotal" class="order-total"></div>
        </div>
        <div style="text-align:center; margin:1rem 0; padding:1rem; background:#f9f9f9; border-radius:8px;">
          <h3 style="color:var(--brand); margin-bottom:.5rem;">Please come shop again! üòä</h3>
          <p style="color:var(--muted);">We appreciate your business and look forward to serving you again.</p>
        </div>
        <div class="modal-actions" style="justify-content:center">
          <button id="closeModal" class="btn btn-primary">Continue Shopping</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Delete product?</h2>
        <p class="confirm-text">This action cannot be undone.</p>
      </div>
      <div class="confirm-actions">
        <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
        <button id="cancelDeleteBtn" class="btn btn-ghost">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Shared overlay -->
  <div id="overlay" class="overlay"></div>

  <!-- Mobile Buy Now Bar -->
  <div class="buy-now-wrap" aria-hidden="true">
    <div id="buyNowBar" class="buy-now-bar" role="region" aria-label="Quick checkout bar">
      <div class="buy-summary">
        üõí <span class="count" id="mobileCartCount">0</span> ‚Ä¢ ‚Ç±<span class="total" id="mobileCartTotal">0.00</span>
      </div>
      <button id="buyNowBtn" class="buy-now-btn" aria-label="Buy Now">
        <span>Buy Now</span> ‚ûú
      </button>
    </div>
  </div>

  <script>
    // --- Data ---
    let products = [
      { id:1, name:"Wireless Bluetooth Headphones", price:2999.50, image:"https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=800&h=600&fit=crop", rating:4.5, reviews:128, isCustom:false, usesObjectURL:false },
      { id:2, name:"Smart Watch Series 8", price:14999.75, image:"https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=800&h=600&fit=crop", rating:4.7, reviews:89, isCustom:false, usesObjectURL:false },
      { id:3, name:"Laptop Stand Adjustable", price:2299.99, image:"https://images.unsplash.com/photo-1527864550417-7fd91fc51a46?w=800&h=600&fit=crop", rating:4.3, reviews:156, isCustom:false, usesObjectURL:false },
      { id:4, name:"Wireless Mouse Gaming", price:3999.99, image:"https://images.unsplash.com/photo-1563297007-0686b7003af7?w=800&h=600&fit=crop", rating:4.6, reviews:203, isCustom:false, usesObjectURL:false },
      { id:5, name:"USB-C Hub 7-in-1", price:1999.99, image:"https://images.unsplash.com/photo-1625842268584-8f3296236761?w=800&h=600&fit=crop", rating:4.4, reviews:94, isCustom:false, usesObjectURL:false },
      { id:6, name:"Smartphone Case Protective", price:1249.99, image:"https://images.unsplash.com/photo-1601593346740-925612772716?w=800&h=600&fit=crop", rating:4.2, reviews:67, isCustom:false, usesObjectURL:false },
      { id:7, name:"Portable Power Bank 20000mAh", price:2499.99, image:"https://images.unsplash.com/photo-1609592424970-91c4699d8ab5?w=800&h=600&fit=crop", rating:4.5, reviews:112, isCustom:false, usesObjectURL:false },
      { id:8, name:"LED Desk Lamp with USB Charging", price:1749.99, image:"https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=800&h=600&fit=crop", rating:4.1, reviews:78, isCustom:false, usesObjectURL:false }
    ];

    let cart = [];
    let nextId = 9;
    let deleteCandidateId = null;

    // --- DOM ---
    const productsGrid = document.getElementById('productsGrid');
    const cartSidebar = document.getElementById('cartSidebar');
    const cartToggle = document.getElementById('cartToggle');
    const closeCart = document.getElementById('closeCart');
    const overlay = document.getElementById('overlay');
    const cartItems = document.getElementById('cartItems');
    const cartCount = document.getElementById('cartCount');
    const cartTotal = document.getElementById('cartTotal');
    const searchInput = document.getElementById('searchInput');

    // Form elements
    const addItemToggle = document.getElementById('addItemToggle');
    const addItemForm = document.getElementById('addItemForm');
    const closeForm = document.getElementById('closeForm');
    const productForm = document.getElementById('productForm');
    const formTitle = document.getElementById('formTitle');
    const editingId = document.getElementById('editingId');
    const productName = document.getElementById('productName');
    const productPrice = document.getElementById('productPrice');
    const productRating = document.getElementById('productRating');
    const productImageFile = document.getElementById('productImageFile');
    const imagePreview = document.getElementById('imagePreview');

    // Modals
    const checkoutModal = document.getElementById('checkoutModal');
    const closeModal = document.getElementById('closeModal');
    const orderItems = document.getElementById('orderItems');
    const orderTotal = document.getElementById('orderTotal');

    const deleteModal = document.getElementById('deleteModal');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

    // Mobile Buy Now bar
    const buyNowBar = document.getElementById('buyNowBar');
    const buyNowBtn = document.getElementById('buyNowBtn');
    const mobileCartCount = document.getElementById('mobileCartCount');
    const mobileCartTotal = document.getElementById('mobileCartTotal');

    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
      displayProducts(products);
      updateCartUI();
      setupEvents();
      updateBuyNowBar(); // ensure initial state
    });

    function setupEvents(){
      cartToggle.addEventListener('click', () => {
        if (isMobile()){
          flashBuyNowBar();
          // Scroll to bottom to reveal the bar area
          window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
          return;
        }
        openCart();
      });
      if (closeCart) closeCart.addEventListener('click', closeCartSidebar);
      overlay.addEventListener('click', () => { closeCartSidebar(); hideAllModals(); });
      searchInput.addEventListener('input', handleSearch);

      addItemToggle.addEventListener('click', () => openFormForCreate());
      closeForm.addEventListener('click', () => closeAddItemForm());
      productForm.addEventListener('submit', onSubmitProductForm);
      productImageFile.addEventListener('change', handleImageFileChange);

      closeModal.addEventListener('click', () => { checkoutModal.classList.remove('active'); overlay.classList.remove('active'); });

      confirmDeleteBtn.addEventListener('click', confirmDelete);
      cancelDeleteBtn.addEventListener('click', hideDeleteModal);

      // Buy now
      buyNowBtn.addEventListener('click', () => {
        if (cart.length === 0){ showNotification('Your cart is empty!'); return; }
        checkout();
      });

      window.addEventListener('resize', () => {
        updateBuyNowBar();
      });
    }

    // --- Helpers ---
    const isMobile = () => window.innerWidth <= 768;
    function showOverlay(){ overlay.classList.add('active'); }
    function hideOverlay(){ overlay.classList.remove('active'); }
    function hideAllModals(){ checkoutModal.classList.remove('active'); deleteModal.classList.remove('active'); }

    // --- Products ---
    function displayProducts(list){
      productsGrid.innerHTML = '';
      list.forEach(p => {
        const el = document.createElement('div');
        el.className = `product-card ${p.isCustom ? 'custom-item' : ''}`;
        el.innerHTML = `
          ${p.isCustom ? '<div class="custom-badge">NEW</div>' : ''}
          <img class="product-image" src="${p.image}" alt="${escapeHtml(p.name)}" />
          <div class="product-info">
            <h3 class="product-name">${escapeHtml(p.name)}</h3>
            <div class="product-price">‚Ç±${p.price.toFixed(2)}</div>
            <div class="product-rating">
              <span class="stars">${generateStars(p.rating)}</span>
              <span class="rating-text">${p.rating} (${p.reviews} reviews)</span>
            </div>
            <div class="card-actions">
              <button class="btn btn-primary" onclick="addToCart(${p.id})">Add to Cart</button>
              <button class="btn btn-ghost" onclick="openFormForEdit(${p.id})">Edit</button>
              <button class="btn btn-danger" onclick="showDeleteModal(${p.id})">Delete</button>
            </div>
          </div>
        `;
        productsGrid.appendChild(el);
      });
    }

    function generateStars(rating){
      const full = Math.floor(rating); const half = rating % 1 !== 0; let s = '';
      for (let i=0;i<full;i++) s += '‚òÖ'; if (half) s += '‚òÜ'; return s;
    }

    // --- Add/Edit Form Logic ---
    function openFormForCreate(){
      formTitle.textContent = 'Add New Product';
      editingId.value = '';
      productForm.reset();
      imagePreview.src = '';
      addItemForm.classList.add('active');
      window.scrollTo({ top: addItemForm.offsetTop - 20, behavior: 'smooth' });
    }

    function openFormForEdit(id){
      const p = products.find(x => x.id === id);
      if (!p) return;
      formTitle.textContent = 'Edit Product';
      editingId.value = String(p.id);
      productName.value = p.name;
      productPrice.value = p.price;
      productRating.value = p.rating;
      imagePreview.src = p.image || '';
      productImageFile.value = '';
      addItemForm.classList.add('active');
      window.scrollTo({ top: addItemForm.offsetTop - 20, behavior: 'smooth' });
    }

    function closeAddItemForm(){ addItemForm.classList.remove('active'); productForm.reset(); imagePreview.src = '' }

    function handleImageFileChange(e){
      const file = e.target.files && e.target.files[0];
      if (file){
        const url = URL.createObjectURL(file);
        imagePreview.src = url;
        imagePreview.dataset.objectUrl = url; // mark for potential revoke
      } else {
        imagePreview.src = '';
        delete imagePreview.dataset.objectUrl;
      }
    }

    function onSubmitProductForm(e){
      e.preventDefault();
      const idStr = editingId.value.trim();
      const name = productName.value.trim();
      const price = parseFloat(productPrice.value);
      const rating = parseFloat(productRating.value);

      if (!name || !(price >= 0) || !(rating >= 1 && rating <= 5)){
        showNotification('Please fill out the form correctly.');
        return;
      }

      // Determine image to use
      let imageUrl = imagePreview.src || '';
      const hasNewFile = !!productImageFile.files[0];

      if (idStr){
        // Update existing
        const id = parseInt(idStr, 10);
        const idx = products.findIndex(p => p.id === id);
        if (idx !== -1){
          const prev = products[idx];
          // Revoke previous object URL if replaced
          if (hasNewFile && prev.usesObjectURL && prev.image && prev.image.startsWith('blob:')){
            try{ URL.revokeObjectURL(prev.image) }catch{}
          }
          products[idx] = {
            ...prev,
            name,
            price,
            rating,
            image: hasNewFile ? imageUrl : prev.image,
            usesObjectURL: hasNewFile ? true : prev.usesObjectURL
          };
          displayProducts(products);
          showNotification('Product updated');
        }
      } else {
        // Create new
        const newItem = {
          id: nextId++,
          name,
          price,
          image: imageUrl || '',
          rating,
          reviews: Math.floor(Math.random()*50)+1,
          isCustom: true,
          usesObjectURL: !!hasNewFile
        };
        products.unshift(newItem);
        displayProducts(products);
        showNotification('Product added');
      }

      // Cleanup preview object URL (we stored it in products if used)
      if (imagePreview.dataset.objectUrl){
        // keep it; now owned by the product item
        delete imagePreview.dataset.objectUrl;
      }

      closeAddItemForm();
    }

    // --- Delete flow with modal ---
    function showDeleteModal(id){ deleteCandidateId = id; deleteModal.classList.add('active'); showOverlay(); }
    function hideDeleteModal(){ deleteCandidateId = null; deleteModal.classList.remove('active'); maybeHideOverlay(); }
    function confirmDelete(){
      if (deleteCandidateId == null) return;
      const p = products.find(x => x.id === deleteCandidateId);
      // Revoke object URL if any
      if (p && p.usesObjectURL && p.image && p.image.startsWith('blob:')){ try{ URL.revokeObjectURL(p.image) }catch{} }
      products = products.filter(p => p.id !== deleteCandidateId);
      cart = cart.filter(c => c.id !== deleteCandidateId);
      displayProducts(products);
      updateCartUI();
      showNotification('Product deleted successfully!');
      hideDeleteModal();
    }

    function maybeHideOverlay(){ if (!cartSidebar.classList.contains('open') && !deleteModal.classList.contains('active') && !checkoutModal.classList.contains('active')) hideOverlay(); }

    // --- Cart ---
    function addToCart(productId){
      const product = products.find(p => p.id === productId); if (!product) return;
      const existing = cart.find(i => i.id === productId);
      if (existing) existing.quantity++; else cart.push({ ...product, quantity:1 });
      updateCartUI();
      // Mobile haptics + button bump
      if (isMobile()){
        try{ if (navigator.vibrate) navigator.vibrate(20); }catch{}
        buyNowBtn.classList.remove('bump'); // restart animation
        void buyNowBtn.offsetWidth;
        buyNowBtn.classList.add('bump','pulse');
        setTimeout(()=> buyNowBtn.classList.remove('pulse'), 1200);
      }
      showNotification('Added to cart!');
    }

    function updateCartUI(){
      cartItems.innerHTML = '';
      let total = 0;
      if (cart.length === 0){
        cartItems.innerHTML = '<div class="empty-cart">Your cart is empty üõí<small>Add items to see them here.</small></div>';
      } else {
        cart.forEach(item => {
          const row = document.createElement('div');
          row.className = 'cart-item';
          row.innerHTML = `
            <img class="cart-item-image" src="${item.image}" alt="${escapeHtml(item.name)}">
            <div style="flex:1">
              <div class="cart-item-name">${escapeHtml(item.name)}</div>
              <div class="cart-item-price">‚Ç±${item.price.toFixed(2)}</div>
              <div class="quantity-controls">
                <button class="quantity-btn" onclick="changeQuantity(${item.id}, -1)">‚àí</button>
                <input class="quantity-input" value="${item.quantity}" readonly />
                <button class="quantity-btn" onclick="changeQuantity(${item.id}, 1)">+</button>
              </div>
            </div>
            <button class="remove-item" onclick="removeFromCart(${item.id})">Remove</button>
          `;
          cartItems.appendChild(row);
          total += item.price * item.quantity;
        });
      }
      cartCount.textContent = cart.reduce((s,i)=>s+i.quantity,0);
      cartTotal.textContent = `Total: ‚Ç±${total.toFixed(2)}`;
      updateBuyNowBar();
    }

    function changeQuantity(productId, delta){
      const item = cart.find(i => i.id === productId); if (!item) return;
      item.quantity += delta; if (item.quantity <= 0) cart = cart.filter(i => i.id !== productId);
      updateCartUI();
    }

    function removeFromCart(productId){ cart = cart.filter(i => i.id !== productId); updateCartUI(); showNotification('Item removed from cart'); }

    function openCart(){ cartSidebar.classList.add('open'); showOverlay(); }
    function closeCartSidebar(){ cartSidebar.classList.remove('open'); maybeHideOverlay(); }

    // --- Checkout ---
    function checkout(){
      if (cart.length === 0){ showNotification('Your cart is empty!'); return; }
      orderItems.innerHTML = '';
      let total = 0;
      cart.forEach(item => {
        const el = document.createElement('div'); el.className = 'order-item';
        el.innerHTML = `
          <img class="order-item-image" src="${item.image}" alt="${escapeHtml(item.name)}" />
          <div style="flex:1">
            <div class="order-item-name">${escapeHtml(item.name)}</div>
            <div class="order-item-price">‚Ç±${item.price.toFixed(2)} √ó ${item.quantity}</div>
          </div>`;
        orderItems.appendChild(el);
        total += item.price * item.quantity;
      });
      orderTotal.textContent = `Total: ‚Ç±${total.toFixed(2)}`;
      checkoutModal.classList.add('active'); showOverlay();
      cart = []; updateCartUI();
    }

    // --- Search ---
    function handleSearch(){
      const q = searchInput.value.toLowerCase();
      const filtered = products.filter(p => p.name.toLowerCase().includes(q));
      displayProducts(filtered);
    }

    // --- Mobile Buy Now Bar logic ---
    function updateBuyNowBar(){
      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
      const totalPrice = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
      mobileCartCount.textContent = totalItems;
      mobileCartTotal.textContent = totalPrice.toFixed(2);

      if (isMobile()){
        if (totalItems > 0){
          buyNowBar.classList.add('show');
        } else {
          buyNowBar.classList.remove('show');
        }
      } else {
        buyNowBar.classList.remove('show');
      }
    }

    function flashBuyNowBar(){
      if (!isMobile()) return;
      buyNowBar.classList.add('highlight');
      setTimeout(()=> buyNowBar.classList.remove('highlight'), 800);
    }

    // --- Utils ---
    function showNotification(message){
      const n = document.createElement('div');
      n.textContent = message;
      n.style.position='fixed'; n.style.bottom='20px'; n.style.right='20px'; n.style.background='var(--brand)'; n.style.color='#fff';
      n.style.padding='10px 14px'; n.style.borderRadius='8px'; n.style.boxShadow='0 2px 8px rgba(0,0,0,.2)'; n.style.zIndex='400'; n.style.fontWeight='800'; n.style.transition='opacity .5s';
      document.body.appendChild(n);
      setTimeout(()=>{ n.style.opacity='0'; setTimeout(()=> n.remove(), 500); }, 1800);
    }
    function escapeHtml(str){ return String(str).replace(/[&<>"] /g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"," ":"&nbsp;"}[s]||s)); }

    // Expose functions used in inline handlers
    window.addToCart = addToCart;
    window.openFormForEdit = openFormForEdit;
    window.showDeleteModal = showDeleteModal;
    window.changeQuantity = changeQuantity;
    window.removeFromCart = removeFromCart;
    window.checkout = checkout;
  </script>
</body>
</html>
